const express = require('express');
const fs = require('fs');
const path = require('path');
const app = express();

const PORT = process.env.PORT || 3000;
const SAVE_DIR = path.join(__dirname, 'submissions');
if (!fs.existsSync(SAVE_DIR)) fs.mkdirSync(SAVE_DIR, { recursive: true });

// phục vụ giao diện từ thư mục public
app.use(express.static(path.join(__dirname, 'public')));

// nhận dữ liệu thô từ sendBeacon
app.post('/submit-beacon', express.raw({ type: '*/*', limit: '512kb' }), (req, res) => {
  let data = {};
  try {
    data = JSON.parse(req.body.toString('utf8'));
  } catch {
    data = { content: req.body.toString('utf8') };
  }

  const content = (data.content || '').trim();
  if (!content) return res.status(200).send('no content');

  const ts = new Date().toISOString().replace(/[:.]/g, '-');
  const rand = Math.floor(Math.random() * 90000) + 10000;
  const filename = `bai-${ts}-${rand}.txt`;
  const filepath = path.join(SAVE_DIR, filename);

  fs.writeFile(filepath, content, 'utf8', (err) => {
    if (err) {
      console.error('Lưu lỗi:', err);
      return res.status(500).send('error');
    }
    console.log('✅ Đã lưu:', filepath);
    res.status(200).send('ok');
  });
});

app.listen(PORT, () => console.log(`🚀 Server chạy ở http://localhost:${PORT}`));
